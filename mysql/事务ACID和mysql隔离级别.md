# 事务的ACID
- 原子性：事务里的操作要么全部执行成功，要么不成功，失败的时候执行回滚操作。
- 持久性：一旦事务修改了数据项，这个修改的效果将会是永久的。
- 隔离性：不同的事务之间不能相互干扰。
- 一致性：这里说的是数据执行事务前后的状态一致。假设我们10个人，每人有一个账号，里面有钱，可以转来转去，这组成了一个小型的数据系统，那么什么叫数据一致性？这是由你自己来定义的，比较通用的就是：
这10个人的账号金额总数不变——满足这一条件，就叫数据一致，不满足，就叫数据不一致，或者在分布式的环境下，有一个数据在几个地方都保存了，那么任何时候，这几个地方的数据都必须相同，这也叫一致性。  

原子性和一致性的区别联系：如果有一个事务，还是上面的例子，如果`A=A-100`，那么为了保持一致性这个状态，必须其它地方加100,。原子性，`A=A+100,B=B+100`，就算原子性得到了保证，一致性也没得到保证。  

# mysql中的事务隔离级别

1.读未提交：就是一个事务读取到了另一个事务未提交的数据。或者是读取到其它事务回滚之前的值了，导致了`脏读`。  
2.不可重复读：就是一个事务在同一个事务执行过程中执行查询的语句前后两次的结果不一。  解决了：脏读
3.重复读：就是一个事务在同一个事务执行过程中执行查询的语句前后两次的一致。  解决了：脏读，不可重复读
4.串行化：将事务串行化执行。 解决了：脏读，不可重复读，幻读（幻读后面再讲）。  

mysql中引擎有innodb，MyISAM，memory。下面的讲解默认在innodb下面，innodb下面默认的隔离级别是可重复读。  

# mysql中锁的机制  
1.行锁（record lock），默认就是行锁，不过锁的是索引，不是锁的记录。  
2.表锁，将整个表加锁，加锁粒度大，并发度不好。  
3.页锁，一次锁定相邻的一组记录。  

gap lock（间隙锁）：给数据区间范围上锁  
next-key lock：是record lock和gap lock的组合，既锁住记录本身还锁住索引之间的间隙。  

# 幻读  
幻读：官方给的定义就是同一个事务两次同一个查询的得出的结果数不一样就是幻读，比如删除了或者新增了。下结论：
- 当前读：通过next-key解决了幻读。（在select 后面加上lock share mode或者for update。 ）
- 快照度：通过多版本并发控制协议解决了幻读，MVCC。（简单的select 操作。）  

当前读，简单来说了就是通过给区间加锁，那么在此区间内的数据不能新增或者删除。这样前后读取的数据就一致了。  
快照读，每一个事物的`第一个select`会创建一个快照（可以看出一个历史数据版本），我这边看的资料少，在每行记录中有一个创建版本号和删除版本号，版本号就是事物id。快照读只会读取那些事物版本号小于当前事务版本
号和删除版本号大于当前事务版本号的数据。  
额外：这样可以确保事务读取的行，要么事务开始前已经存在的，要么事务自身插入或者修改过。而删除呢，确保事务读取到的行，在事务开始之前未被删除。
