# 复制的一般过程  
- 从节点执行slaveof masterip:port 命令，从节点保存完主节点的地址后直接返回。  
- 从节点定时尝试去和主节点建立连接，除非取消复制，不然持续到连接成功。  
- 执行ping命令，看主节点和网络情况是否可以执行复制命令。  
- 出于安全性的考虑，不能只要知道redis地址的人都能复制数据对吧，这不显示，所以还要做一个安全验证。  
- 执行全量复制，将主节点的数据发送给从节点。  
- 同时主节点可能一直在执行，不停的有新的写命令或者删除命令，因此还要持续写入。  

![主从复制过程](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/%E5%A4%8D%E5%88%B6%E8%BF%87%E7%A8%8B.png)  

# 数据同步  
数据同步由全量复制和部分复制两种方式，Redis在2.8及以上版本使用psync命令完成主从数据同步。基础三大组件：
- 复制偏移量：主节点保存了自己节点和从节点每秒上传的复制偏移量，简单理解就是复制了多少，通过对比这两个偏移量得出主从节点数据是否一致。  
- 复制积压缓存区：在主节点中会简历一个1m大小的队列来存放最近执行的命令，主要用于较短时间内数据的丢失恢复。当然如果恢复的时候复制偏移量不在积压缓存区内，则会触发全量复制。
- 主节点运行id：如果只使用ip+port的方式识别主节点，那么主节点重启变更了整体数据集（如替换RDB/AOF文件），从节点再基于偏移量复制数据将是不安全的，因此当运行ID变化后从节点将做全量复制。这个id可以设置重启后不变化。

psync命令执行过程：  
- 从节点通过psync命令，参数为runid发送给主节点，参数offset在第一次发送时为-1。
- 主节点根据psync的参数和自身情况来决定回复什么参数给从节点，有全量复制，部分复制，命令低于redis2.8，采用老命令完成复制等三种情况。

# 全量复制  

定义：一般为第一次复制时，执行的操作，将主节点信息全部推给从节点，如果数据量较大，对主从节点的网络开销就比较大。全量复制的过程和上面的复制一般过程大致相同，其中是主节点通过bgwrite命令生成rdb文件，将
rdb文件发给从节点，从节点删除自身旧数据，重新加载主节点发送过来的rdb文件，**额外**说一点就是在主节点将rdb文件发送给从节点的时候，必然有新的命令不断执行，这部分命令放在缓存区，当rdb文件传输完成后再发送
给从节点。最后从节点也加载完了adb文件，如果从节点开启了aof持久化操作，从节点bgrewriteaof命令执行备份操作。因为全量复制太耗时了，所以出现了部分复制。



# 部分复制  

用于处理在主从复制中因网络闪断等原因造成的数据丢失场景，当从节点再次连上主节点后，如果条件允许，主节点会补发丢失数据给从节点。因为补发的数据远远小于全量数据，可以有效避免全量复制的过高开销还是说一下大致流程，当主从节点之间出现了网络中断的时候，中断复制链接，同时主节点会将此期间的命令保存在积压缓存区，当从节点的网络恢复后，从节点将之前保存的主节点的运行id和offset发送主节点，主节点会
校验运行id是不是自己，如果是的话，那么再对比复制偏移量，如果偏移量之后的数据在缓存区则将数据发送给从节点。  

# 异步复制  
主节点不但负责数据读写，还负责把写命令同步给从节点。写命令的发送过程是异步完成，也就是说主节点自身处理完写命令后直接返回给客户端，并不等待从节点复制完成。  

# 一些常见问题  
1.读写分离，从节点只能用来进行读操作，从节点永远不会主动删除数据，除非执行主节点的异步删除命令。从节点的读操作也有可能引发下面的问题：
- 如果网络延迟较高，可能导致刚刚插入的数据，在从节点无法读到。这种时候的解决方案就是通过对比主节点和对应从节点的复制偏移量，如果超过一定的值，读命令就不要路由到该从节点，除非该丛节点网络恢复正常
并且基本上完成了主从数据复制。  
- 读到过期数据，redis对于过期键的策略有两种
    - 惰性策略，在执行读命令时，如果发现过期了，则直接删除主节点的数据，并且del也会异步发送给丛节点。
    - 定时策略，主节点会定时采样遍历键，发现过期的会删除，并异步发给从节点。3.2中已经解决了采样速度跟不上过期速度的问题，即丛节点在返回数据时会检查数据是否已经过期。  
- 避免复制风暴，当主节点重启后，大量从节点要来进行复制命令操作，虽然redis做了优化，只会产生一份rdb快照。为了解决这个问题，可以减少主节点挂挂载的从节点数量或者采用树状拓扑结构，减轻最顶层主节点的压力。

