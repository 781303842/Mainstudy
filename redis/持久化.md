# RDB(redis database)  
有以下几个步骤：
- 主线程执行RDB命令，如果已经存在持久化进程，则直接返回
- 如果不存在，主线程fork一个子**进程**去同步RDB文件；同时主线程继续做其他事
- 子进程同步完文件后，通知主进程。  

![rdb流程](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/rdb%E6%B5%81%E7%A8%8B.png)  

触发机制：手动触发分别对应save和bgsave命令；还有当比如debug reload的时候等等都会自动触发RDB操作；但是要事先配置才行。  
优点：适合全量备份，针对某个时间点。压缩的文件更小。  
缺点：不能做到秒级备份，在一些对数据安全性要求较高的地方不适用。每一个版本都有特定的格式，老版本的redis无法兼容。也正因如此，一般的开发者都采用下面一种。  

# AOF（append only file）  
以独立日志的方式记录每次写命令，重启时再重新执行AOF文件中的命令达到恢复数据的目的。也先上一张图。  
![aof流程](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/aof%E6%B5%81%E7%A8%8B.png)  
- 命令写入：通过字符串直接记录。  
- Aof缓冲到aof文件有三种同步策略，必备知识，同步通过sync和write来完成，其中sync是阻塞直到同步完成，write延迟写，将aof缓存写到系统buffer后，由操作系统一定时间后写入物理存储设备：
    - always：aof命令写入后，调用sync，同步完成后返回。（不推荐，写入数据到硬盘费时，拖累redis）
    - everysec:aof命令写入后，调用write，返回；sync同步操作由专门的线程每秒执行一次。（推荐，既保证安全性，又保证了性能）
    - no:aof命令写入后，调用write，返回;不做aof文件做同步sync操作，同步由操作系统负责，最长30s执行一次。（不推荐，同步周期没法控制，没法做到数据安全）
- 重写机制：因为aof文件可能持续增大，为了解决这个问题，必须对aof文件进行重写，一般来说有以下几种策略：  
    - 清除超时数据
    - 无效操作，比如del xx，这种。
    - 合并命令，但是有一个长度限制，不然太长了怕客户端缓存区溢出，一般64个元素为一组。
 - 重启加载：会优先加载aof文件，其次才是rdb。
