# ipv4  

![ipv4数据报格式](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/ipv4%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)  

- 版本：ip协议的版本。 
- 首部长度：一般为4个字节
- 总长度：首部和数据的总长度，以太网的最长字节数为1500,字节，因此数据报的总长度不能超过这个。
- 标识：每产生一个数据包就+1，不是序号，当数据包长度超过MTU的时候，就需要分片，每个数据包片都复制一个标识，同一个数据报分片后的标志位都是一样的，方便后面组装。
- 标志：用来区分是否可以分片，以及后面是否还有分片的数据报。
- 片偏移： 分片后的数据相当于原数据报的位置，分片是以8字节为单位，因此偏移量也是。
- 首部校验和：只校验首部，不校验数据部分。
- 生存时间TTL：可通过路由的最大数量，到0的时候就会被丢弃，主要作用就是防止数据报在网络中循环。
- 协议：指出此分组携带的是那种协议，分别交由对应的传输层处理，如TCP好UDP。
- 源地址字段：发送方的IP地址。
- 目的地址：接收方的IP地址。  


1.网络层路由转发算法大致过程：
当前子网掩码与的结果相等，那就说通过这个路由器进行转发，一个路由器应该有多个网卡，处于多个不同的网段）
- 从数据报首部提出目的地址ip，D，得出目标网络地址为N，然后查找当前路由器的路由表
- 如果有此N与该路由器直接相连，则将数据报直接发送给D、
- 如果不相连，若有到达网络N的路由，则把数据包传输给下一跳的路由器
- 如果都没有，那就走默认路由地址
- 上面都没转发出去，那就转发出错。  

2.ipv4地址分类  
ip地址，全球任意一个电脑连入网络中时，都会在当前网络环境下具有唯一的32位ip。有A,B,C,D,E五类，如下图：
![分类的ip地址](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/%E5%88%86%E7%B1%BB%E7%9A%84ip%E5%9C%B0%E5%9D%80.png)  

主机号全为0，表示本网络本身;主机号全为1表示本网络的广播地址；32位全为0表示本网络本主机；32位全为1表示整个tcp/ip的广播地址。ip地址还有以下一些特点：
- ip地址分为网络号和主机号，地址分配机构只负责网络号的分配，主机号的分配由使用单位自行分配，上面路由转发的时候也是根据网络号来的。  
- ip地址是标志一个路由器或者主机和一条链路的唯一接口，因此路由器挚至少要有两个ip地址。
- 用转发器或者桥接器连接起来的网络任然属于一个网络
- NAT将私有网络地址转换为公有网络地址。三个私有ip段，私有ip只有局域网能用。10.0.0.0-10.255.255.255,172.16.0.0-172.31.255.255,192.168.0.0-192.168.255.2555  

3.子网划分，子网掩码和CIDR  
如果给每一个网络都分配一个网络号，那么路由表将变大，效率降低。因此有人提出了子网划分。
- 划分子网只是一个单位内部的事，对外部来说没有子网的存在
- 子网是在`主机号`借了几位，当然主机号也减少了几位
- 一个外部的数据报首先根据网络号找到本单位对外的路由器，然后实现子网的划分，最后发送到对应的主机上。  

3.1 为了告诉主机或者路由器我们进行了子网的划分，因此通过子网掩码来表达对原主机号的借位。子网掩码也是32位。`ABC三类网络号的默认子网掩码就是255.0.0.0,255.255.0.0,255.255.255.1`,因此路由表的结构就有三部分`目的网络号，子网掩码，下一跳地址`。所以路由转发的过程可以详细为下面的流程：
- 从收到的数据报中提取目的ip地址，记为D
- 对路由器**直接**相连的网络都进行检查：将D和路由表中每一项子网掩码与操作，如果发现了符合的网络则直接交付。
- 若发现目的地址是一个特定的路由器，则将数据传递给当前路由表指的下一个路由器。
- 将路由表中的**每一个**子网掩码都与D进行与操作，若结果和对应的目的网络号相等，则将数据发送到下一跳的路由器
- 如果上面还没发完，那就走路由表中的默认路由
- 路由出错。  

3.2 无分类编址路由（CIDR）  
是在变长子网掩码上提出一种消除传统网络中子网的划分方式，使用`前缀：主机号`来表示，或者斜线表示法，即`网络地址/数字`后面的数字表示有多少个连续的1，从高位算起，这多个连续的1就是子网掩码。CIDR虽然不使用"子网"，是指没有明确多少位作为子网划分的依据，但是还是有掩码的概念，一个分配ip地址/20的地址块，任然能从主机借3位来分配子网。`将网络前缀号都相同的连续ip组成一个CIDR地址块`，这种方式叫做路由聚合，或称为超网。如下图,CIDR可以降低路由表的容量，提高查找速度。使用的最长匹配原则，说白了就是找最长的公共部分，因此在路由表中可以匹配不止一个，所以返回最长匹配的那个，底层结构是二叉线索树。
![CIDR](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/CIDR.png)  

3.3 ARP协议，DHCP协议，ICMP协议  
在网络层及以上的层中都使用的ip地址，而链路层使用的mac硬件地址（链路层只能看见mac帧）。由于路由器的隔离，网络层只能通过网络号先找目的网段，再在目的网段中广播寻找和目的MAC一样的主机。又因为路由器转发时要解析和组装，起源mac地址肯定会变化，所以不能用于通讯。
- ARP（address resolution protocol）协议，无论网络层使用什么协议，最终都要用硬件地址，这种将ip地址转为mac地址的方式就叫ARP。
    + 每一个主机都有一个ARP高速缓存，记录着本局域网每一个主机和路由器的ip地址到mac地址的转换。arp表由arp协议维护。（arp工作在网络层）
    + 工作原理1：如果主机A要给B主机发送消息，那么首先在自己的ARP表中查看是否有主机B的ip，如果有，那么将对应的mac地址填写到mac帧的目的物理中，再发送出去。
    + 工作原理2：如果没有找到，那么就将本mac帧的目的物理地址改为广播地址即主机号全为1，如果目的主机在同一个局域网，那么目的主机会将自己的ip地址和mac地址发给主机A。
    + 如果没有找到，那说明不在同一个网段，需要发送给网段号相同的路由器，再通过路由器转发，去寻找。
- RARP（逆）:通过硬件地址找到ip地址，现在已经被包含到了DHCP中。
- DHCP（动态配置协议，dynamic host configuration protocol）：给主机动态的分配ip地址。DHCP是应用层协议，基于UDP。
    + 工作原理1：客户机广播`DHCP发现:`，只有DHCP服务器才会响应
    + 工作原理2：DHCP服务器接收到后，广播`DHCP提供`，其中包括打算分配的ip地址等信息
    + 工作原理3：客户机如果接受，就广播，让HDCP服务器提供ip。（为什么有下面两步，因为服务机要知道我这个ip客户机用不用，如果用了我还要记录一下谁用的，用多久）
    + 工作原理4：HDCP服务器确认，将ip地址分配出去。DHCP是基于广播，因为不知道目的ip；既然ip都不知道肯定无法建立连接，因此使用udp。
- ICMP协议（网际控制报文协议）：为了提高网络层数据交付的成功性，在网络层使用ICMP（internet control message protocol）来允许主机或者路由器报告异常和错误。ICMP报文作为ip数据报的数据和首部一起发出去，`ICMP是网络层协议`，有差错报告报文和询问报告。ICMP常用的两个一个是ping（工作在应用层），traceroute/tracet（工作在网络层）。   

# ipv6
1.ipv6相对于IPv4的地址空间从32位扩展为提高到128位  

2.ipv6实现了包头设计的简化，降低了网络设备多包处理的负荷  

3.ipv6实现了地址的自动化配置，无需部署DHCP也能部署  

# 路由协议  
1.域内路由和域间路由：一个自治系统内的路由器都是必须是连通的，一个大学，单位都可以成为一个自治系统。  
![自治系统](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/%E8%87%AA%E6%B2%BB%E7%B3%BB%E7%BB%9F.png)  

- 内部网关协议（interior gateway protocol，IGP）
    + rip(route information protocol，应用层协议，传输层使用udp协议),是一种基于距离向量的路由协议
        - rip规定每一个路由器都要维护到其它网络的距离，因此是一组距离，称为距离向量，距离就是跳数，好的路由就是通过的跳数少。最多只能15跳，16跳就认为网络不可达。根据上面的描述，可以看出rip只能适应于小型的网络。任意两个使用rip协议的路由器每30s广播一次rip路由信息，以便于维护路由表。
        - rip的特点：1.只和相邻的且使用rip协议的路由器进行交换信息（自己的路由表）；每隔30秒执行一次。
        - rip算法大致过程：1.把从x节点发送过来的路由表数中所有下一跳地址都改为x，并把所有的“距离”字段加1。2.当x路由表中有些网络不在当前路由表则直接添加；如果在，并且下一跳是x，则更新；3.当原来的路由表有x发送过来的路由表中的某些网络，并且下一跳不是x的时候（说明有其它更短的路径），如果距离小于则更新，否则什么都不做。4.如果180s还没收到相邻路由器的路由表，则把这个距离设置为16表示不可达。
        - 缺点：当网络故障的时候，坏消息传的慢，因为要更新所有路由器需要时间。
    + ospf（开放最短路径优先）
        -  链路状态路由算法：通过洪泛法向本自治系统所有路由器发送消息（注意洪泛攻击）；发送的消息就是所有和本路由相邻路由器的状态，包括哪些路由器，度量等信息；并且只有链路状态改变时才会向所有路由器发送消息。是网络层协议直接使用ip数据报擦传送。更新过程快，不会出现坏消息传的慢的结果。
        - ospf特点：1如果同样的目的网络有多条代价相同的路径，还可以将通讯分配到这几条上，做负载均衡。具有鉴别功能，只在可信赖的路由器交换信息。
        - ospf算法大致过程：每个路由器最终都会有一个全网的拓扑结构图，然后使用迪杰特斯拉算法算出当前路由到其它路由的最短路由，注意只会保存“下一跳，而不是全部路径，这里并不是说保存相邻的最短那一条，而是迪杰特斯拉算法执行完后，会导致后面每一跳最优的那个路由器”
        - 为了使ospf应用更大，将一个自治系统分为区域，每个ospf算法只在自己的区域内交换。当然这其中要有一个主域来管理。
- 外部网关协议（external gateway protocol,EGP【应用层，tcp】）
    + BGP-4（border gateway protocol，边际网关协议），不用自治系统之间交换路由的协议。
        - 路由表包括，已知的路由器列表，路由器能够到达的地址，跳数
        - 算法过程：路径向量路由选择协议；每个自治系统都要选择一个或者多个作为该自治系统跟其他系统交换信息的代表，交换信息之前要建立tcp连接，建立BGP会话，通过BGP传递路由消息，当所有的代表都交换完路由可达性信息后，各个代表就知道了到达其他系统的较好的路径。（其中代表不仅要运行内部协议，比如rip还要运行外部协议）  
        
![三种路由协议的一个比较](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/%E4%B8%89%E7%A7%8D%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%B8%80%E4%B8%AA%E6%AF%94%E8%BE%83.png)
