# ipv4  

![ipv4数据报格式](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/ipv4%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)  

- 版本：ip协议的版本。 
- 首部长度：一般为4个字节
- 总长度：首部和数据的总长度，以太网的最长字节数为1500,字节，因此数据报的总长度不能超过这个。
- 标识：每产生一个数据包就+1，不是序号，当数据包长度超过MTU的时候，就需要分片，每个数据包片都复制一个标识，同一个数据报分片后的标志位都是一样的，方便后面组装。
- 标志：用来区分是否可以分片，以及后面是否还有分片的数据报。
- 片偏移： 分片后的数据相当于原数据报的位置，分片是以8字节为单位，因此偏移量也是。
- 首部校验和：只校验首部，不校验数据部分。
- 生存时间TTL：可通过路由的最大数量，到0的时候就会被丢弃，主要作用就是防止数据报在网络中循环。
- 协议：指出此分组携带的是那种协议，分别交由对应的传输层处理，如TCP好UDP。
- 源地址字段：发送方的IP地址。
- 目的地址：接收方的IP地址。  


1.网络层路由转发算法大致过程：
当前子网掩码与的结果相等，那就说通过这个路由器进行转发，一个路由器应该有多个网卡，处于多个不同的网段）
- 从数据报首部提出目的地址ip，D，得出目标网络地址为N，然后查找当前路由器的路由表
- 如果有此N与该路由器直接相连，则将数据报直接发送给D、
- 如果不相连，若有到达网络N的路由，则把数据包传输给下一跳的路由器
- 如果都没有，那就走默认路由地址
- 上面都没转发出去，那就转发出错。  

2.ipv4地址分类  
ip地址，全球任意一个电脑连入网络中时，都会在当前网络环境下具有唯一的32位ip。有A,B,C,D,E五类，如下图：
![分类的ip地址](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/%E5%88%86%E7%B1%BB%E7%9A%84ip%E5%9C%B0%E5%9D%80.png)  

主机号全为0，表示本网络本身;主机号全为1表示本网络的广播地址；32位全为0表示本网络本主机；32位全为1表示整个tcp/ip的广播地址。ip地址还有以下一些特点：
- ip地址分为网络号和主机号，地址分配机构只负责网络号的分配，主机号的分配由使用单位自行分配，上面路由转发的时候也是根据网络号来的。  
- ip地址是标志一个路由器或者主机和一条链路的唯一接口，因此路由器挚至少要有两个ip地址。
- 用转发器或者桥接器连接起来的网络任然属于一个网络
- NAT将私有网络地址转换为公有网络地址。三个私有ip段，私有ip只有局域网能用。10.0.0.0-10.255.255.255,172.16.0.0-172.31.255.255,192.168.0.0-192.168.255.2555  

3.子网划分，子网掩码和CIDR  
如果给每一个网络都分配一个网络号，那么路由表将变大，效率降低。因此有人提出了子网划分。
- 划分子网只是一个单位内部的事，对外部来说没有子网的存在
- 子网是在`主机号`借了几位，当然主机号也减少了几位
- 一个外部的数据报首先根据网络号找到本单位对外的路由器，然后实现子网的划分，最后发送到对应的主机上。  

3.1 为了告诉主机或者路由器我们进行了子网的划分，因此通过子网掩码来表达对原主机号的借位。子网掩码也是32位。`ABC三类网络号的默认子网掩码就是255.0.0.0,255.255.0.0,255.255.255.1`,因此路由表的结构就有三部分`目的网络号，子网掩码，下一跳地址`。所以路由转发的过程可以详细为下面的流程：
- 从收到的数据报中提取目的ip地址，记为D
- 对路由器**直接**相连的网络都进行检查：将D和路由表中每一项子网掩码与操作，如果发现了符合的网络则直接交付。
- 若发现目的地址是一个特定的路由器，则将数据传递给当前路由表指的下一个路由器。
- 将路由表中的**每一个**子网掩码都与D进行与操作，若结果和对应的目的网络号相等，则将数据发送到下一跳的路由器
- 如果上面还没发完，那就走路由表中的默认路由
- 路由出错。  

3.2 无分类编址路由（CIDR）  
是在变长子网掩码上提出一种消除传统网络中子网的划分方式，使用`前缀：主机号`来表示，或者斜线表示法，即`网络地址/数字`后面的数字表示有多少个连续的1，从高位算起，这多个连续的1就是子网掩码。CIDR虽然不使用"子网"，是指没有明确多少位作为子网划分的依据，但是还是有掩码的概念，一个分配ip地址/20的地址块，任然能从主机借3位来分配子网。`将网络前缀号都相同的连续ip组成一个CIDR地址块`，这种方式叫做路由聚合，或称为超网。如下图,CIDR可以降低路由表的容量，提高查找速度。
![CIDR](https://github.com/781303842/Mainstudy/blob/master/ALLIMG/CIDR.png)

